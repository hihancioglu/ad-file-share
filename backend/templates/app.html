<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Share</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
    th { position: relative; }
    .resizer {
        position: absolute;
        top: 0;
        right: 0;
        width: 5px;
        height: 100%;
        cursor: col-resize;
        user-select: none;
        background-color: #e9ecef;
    }
    .sort-icon {
        cursor: pointer;
    }
    </style>
</head>
<body>
<div class="d-flex">
    <nav id="sidebar" class="bg-light border-end vh-100 flex-shrink-0" style="width: 250px;">
        <div class="p-3">
            <img src="/static/logo-small.png" alt="Logo" class="img-fluid mb-3 mx-auto d-block" style="max-width: 120px;">
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="#upload"><i class="bi bi-upload me-2"></i>Yükle</a></li>
                <li class="nav-item">
                    <a class="nav-link" href="#files"><i class="bi bi-folder2-open me-2"></i>Dosyalarım</a>
                    <ul class="nav flex-column ms-3">
                        <li class="nav-item"><a class="nav-link" href="#incoming"><i class="bi bi-inbox me-2"></i>Gelen Dosyalar</a></li>
                        <li class="nav-item"><a class="nav-link" href="#outgoing"><i class="bi bi-box-arrow-up me-2"></i>Giden Dosyalar</a></li>
                        <li class="nav-item d-none" id="pending-menu-item"><a class="nav-link" href="#pending"><i class="bi bi-hourglass-split me-2"></i>Onay Bekleyenler</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#teams"><i class="bi bi-people me-2"></i>Ekipler</a>
                    <ul id="team-menu" class="nav flex-column ms-3"></ul>
                </li>
                <li class="nav-item"><a class="nav-link" href="#activities"><i class="bi bi-clock-history me-2"></i>Aktiviteler</a></li>
            </ul>
        </div>
    </nav>

    <div class="flex-grow-1 p-3">
        <div class="d-flex align-items-center mb-3 position-relative">
            <h1 class="me-3 mb-0">Hoş geldin, <span id="username-display"></span></h1>
            <div class="me-3 position-relative" id="notif-container" style="cursor:pointer;">
                <i id="notif-bell" class="bi bi-bell" style="font-size:1.5rem;"></i>
                <span id="notif-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none"></span>
                <div id="notif-list" class="position-absolute bg-white border rounded d-none p-2" style="top:2rem; right:0; z-index:1000; max-height:600px; width:600px; overflow:auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <i id="notif-clear" class="bi bi-x-circle-fill text-secondary position-absolute" style="top:4px; right:4px; cursor:pointer;"></i>
                    <table class="table table-sm mb-0 mt-4">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Başlık</th>
                                <th>Aksiyon</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <button id="admin-btn" class="btn btn-outline-primary btn-sm me-2 d-none">Admin</button>
            <button id="logout-btn" class="btn btn-outline-secondary btn-sm">Çıkış</button>
        </div>

        <section id="upload" class="mb-4 d-none" style="max-width: 50%;">
            <h2>Dosya Yükle</h2>
            <div id="drop-zone" class="mb-2 border border-primary rounded p-5 text-center w-100" style="cursor: pointer;">
                Dosyaları buraya sürükleyin veya tıklayın
                <input type="file" id="file-input" name="files" multiple hidden>
            </div>
            <h5 id="pending-title" class="d-none">Yüklenecek Dosyalar</h5>
            <ul id="file-list" class="list-group mb-2"></ul>
            <div class="d-flex mb-2 align-items-center">
                <label for="file-expiry" class="me-2">Geçerlilik Tarihi</label>
                <select id="file-expiry" class="form-select me-2">
                    <option value="1">1 gün</option>
                    <option value="7">7 gün</option>
                    <option value="30" selected>30 gün</option>
                    <option value="60">60 gün</option>
                    <option value="0">Süresiz</option>
                </select>
                <button id="upload-btn" class="btn btn-primary d-none">Yükle</button>
            </div>
            <div id="upload-result" class="mt-2"></div>
        </section>

        <section id="files" class="d-none">
            <h2>Dosyalarım</h2>
            <div class="d-flex align-items-center mb-2">
                <button id="delete-selected" class="btn btn-danger me-2" disabled>Sil</button>
                <button id="share-selected" class="btn btn-primary me-2" disabled>Kullanıcıya Gönder</button>
                <button id="public-share" class="btn btn-outline-primary me-2" disabled>Paylaş</button>
                <button id="add-to-team" class="btn btn-secondary me-2" disabled>Gruba Ekle</button>
                <input type="text" id="file-search" class="form-control me-2" placeholder="Ara..." style="width:auto; max-width:200px;">
                <select id="page-size" class="form-select" style="width:auto;">
                    <option value="15" selected>15</option>
                    <option value="30">30</option>
                    <option value="100">100</option>
                </select>
            </div>
            <table id="file-table" class="table">
                <thead>
                    <tr>
                        <th></th>
                        <th data-field="title">Başlık</th>
                        <th data-field="added">Eklenme Tarihi</th>
                        <th data-field="expires_at">Geçerlilik</th>
                        <th data-field="extension">Uzantı</th>
                        <th data-field="description">Açıklama</th>
                        <th data-field="size">Boyut</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <nav>
                <ul id="file-pagination" class="pagination"></ul>
            </nav>
        </section>

        <section id="incoming" class="d-none">
            <h2>Gelen Dosyalar</h2>
            <table id="incoming-table" class="table">
                <thead>
                    <tr>
                        <th>Dosya</th>
                        <th>Gönderen</th>
                        <th>Geçerlilik</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="outgoing" class="d-none">
            <h2>Giden Dosyalar</h2>
            <table id="outgoing-table" class="table">
                <thead>
                    <tr>
                        <th>Dosya</th>
                        <th>Alıcı</th>
                        <th>Geçerlilik</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="pending" class="d-none">
            <h2>Onay Bekleyenler</h2>
            <table id="pending-table" class="table">
                <thead>
                    <tr>
                        <th>Dosya</th>
                        <th>Gönderen</th>
                        <th>Geçerlilik</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="teams" class="mt-4 d-none">
            <h2>Ekipler</h2>
            <form id="team-form" class="mb-3">
                <input type="text" id="team-name" class="form-control mb-2" placeholder="Ekip adı" required>
                <select id="team-members" class="form-select mb-2" multiple></select>
                <button id="load-users" type="button" class="btn btn-outline-secondary mb-2">Kullanıcı Ekle</button>
                <button class="btn btn-primary" type="submit">Oluştur</button>
            </form>
            <ul id="team-list" class="list-group"></ul>
        </section>

        <section id="team-details" class="mt-4 d-none">
            <h2 id="team-title"></h2>
            <h3>Üyeler</h3>
            <ul id="team-members-list" class="list-group mb-3"></ul>
            <div id="add-member-container" class="mb-3">
                <button id="add-member-btn" class="btn btn-outline-secondary">Kullanıcı Ekle</button>
            </div>
            <h3>Dosyalar</h3>
            <ul id="team-files-list" class="list-group"></ul>
        </section>
        <section id="activities" class="d-none">
            <h2>Aktiviteler</h2>
            <table id="activities-table" class="table">
                <thead>
                    <tr>
                        <th>Kullanıcı</th>
                        <th>Mesaj</th>
                        <th>Kategori</th>
                        <th>Tarih</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Kullanıcı Seç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="ou-tree"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="user-modal-add">Ekle</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="teamModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ekip Seç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <select id="team-select" class="form-select"></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="team-modal-add">Ekle</button>
      </div>
  </div>
</div>
</div>

<div class="modal fade" id="shareLinkModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Paylaş</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info"><i class="bi bi-exclamation-triangle-fill me-2"></i>Bölüm amirinin onayı sonrası dosya paylaşıma açılacaktır.</div>
        <select id="share-expiry" class="form-select">
          <option value="1">1 gün</option>
          <option value="7" selected>7 gün</option>
          <option value="30">30 gün</option>
          <option value="60">60 gün</option>
          <option value="0">Süresiz</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="share-confirm">Paylaş</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Önizleme</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="preview-content"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="downloadLogModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">İndirme Geçmişi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table">
          <thead>
            <tr><th>Tarih</th><th>IP Adresi</th><th>Ülke</th></tr>
          </thead>
          <tbody id="download-log-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="notif-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background: rgba(0, 0, 0, 0.2); z-index:900;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const username = (localStorage.getItem('username') || '').toLowerCase();
if (!username) {
    window.location.href = '/login';
}
localStorage.setItem('username', username);

const _fetch = window.fetch.bind(window);
window.fetch = (url, options = {}) => {
    if (!options.credentials) {
        options.credentials = 'include';
    }
    return _fetch(url, options);
};

const isAdmin = localStorage.getItem('admin') === '1';
const adminBtn = document.getElementById('admin-btn');
const ADMIN_MODE_KEY = 'adminMode';
const USER_STORAGE_KEY = 'selectedFiles';
const ADMIN_STORAGE_KEY = 'adminSelectedFiles';
let adminMode = localStorage.getItem(ADMIN_MODE_KEY) === '1';
const selected = new Set();
function loadSelected() {
    selected.clear();
    const key = adminMode ? ADMIN_STORAGE_KEY : USER_STORAGE_KEY;
    JSON.parse(localStorage.getItem(key) || '[]').forEach(v => selected.add(v));
}
function updateSelectedStorage() {
    const key = adminMode ? ADMIN_STORAGE_KEY : USER_STORAGE_KEY;
    localStorage.setItem(key, JSON.stringify(Array.from(selected)));
    localStorage.setItem(ADMIN_MODE_KEY, adminMode ? '1' : '0');
}
if (isAdmin) {
    adminBtn.classList.remove('d-none');
    adminBtn.textContent = adminMode ? 'Kullanıcı Modu' : 'Admin';
    adminBtn.addEventListener('click', () => {
        updateSelectedStorage();
        adminMode = !adminMode;
        adminBtn.textContent = adminMode ? 'Kullanıcı Modu' : 'Admin';
        loadSelected();
        loadFiles();
        loadTeams();
        loadPending();
        loadActivities();
    });
} else {
    adminMode = false;
}
loadSelected();

const displayName = localStorage.getItem('name') || username;
document.getElementById('username-display').textContent = displayName;
document.getElementById('logout-btn').addEventListener('click', async () => {
    await fetch('/logout', { method: 'POST' });
    localStorage.removeItem('username');
    localStorage.removeItem('name');
    localStorage.removeItem('selectedFiles');
    localStorage.removeItem('adminSelectedFiles');
    localStorage.removeItem('adminMode');
    localStorage.removeItem('admin');
    window.location.href = '/login';
});
const deleteBtn = document.getElementById('delete-selected');
const shareBtn = document.getElementById('share-selected');
const addToTeamBtn = document.getElementById('add-to-team');
const publicShareBtn = document.getElementById('public-share');
const searchInput = document.getElementById('file-search');
const pageSizeSelect = document.getElementById('page-size');
const pagination = document.getElementById('file-pagination');
const PAGE_KEY = 'filesCurrentPage';
let currentPage = parseInt(localStorage.getItem(PAGE_KEY), 10) || 1;
function setCurrentPage(page) {
    currentPage = page;
    localStorage.setItem(PAGE_KEY, page);
}
const SECTION_KEY = 'currentSection';
window.addEventListener('beforeunload', () => {
    updateSelectedStorage();
    localStorage.setItem(PAGE_KEY, currentPage);
    const hash = window.location.hash ? window.location.hash.substring(1) : '';
    if (hash) {
        localStorage.setItem(SECTION_KEY, hash);
    }
});
let currentSort = { field: null, dir: 1 };

function updateSortIcons() {
    document.querySelectorAll('#file-table thead th[data-field] .sort-icon').forEach(icon => {
        icon.className = 'bi bi-arrow-down-up ms-1 sort-icon';
    });
    if (currentSort.field) {
        const icon = document.querySelector(`#file-table thead th[data-field="${currentSort.field}"] .sort-icon`);
        if (icon) {
            icon.className = `bi bi-arrow-${currentSort.dir === 1 ? 'up' : 'down'} ms-1 sort-icon`;
        }
    }
}
let teams = [];
let currentTeamId = null;
let userModalMode = 'create';
let teamModalMode = 'add-files';
let shareFileName = null;
let shareFileNames = [];
let shareExpiry = '';
let currentFiles = [];
let notifications = [];
let activities = [];

const sections = {
    upload: document.getElementById('upload'),
    files: document.getElementById('files'),
    incoming: document.getElementById('incoming'),
    outgoing: document.getElementById('outgoing'),
    pending: document.getElementById('pending'),
    teams: document.getElementById('teams'),
    'team-details': document.getElementById('team-details'),
    activities: document.getElementById('activities')
};

searchInput.addEventListener('input', () => {
    setCurrentPage(1);
    renderFiles();
});

pageSizeSelect.addEventListener('change', () => {
    setCurrentPage(1);
    renderFiles();
});

const sortableHeaders = document.querySelectorAll('#file-table thead th[data-field]');
sortableHeaders.forEach(th => {
    const icon = document.createElement('i');
    icon.className = 'bi bi-arrow-down-up ms-1 sort-icon';
    th.appendChild(icon);
    icon.addEventListener('click', (e) => {
        e.stopPropagation();
        const field = th.dataset.field;
        if (currentSort.field === field) {
            currentSort.dir *= -1;
        } else {
            currentSort.field = field;
            currentSort.dir = 1;
        }
        updateSortIcons();
        renderFiles();
    });
});
updateSortIcons();

['file-table', 'incoming-table', 'outgoing-table', 'pending-table'].forEach(makeColumnsResizable);

function makeColumnsResizable(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    table.querySelectorAll('th').forEach(th => {
        const resizer = document.createElement('div');
        resizer.className = 'resizer';
        th.appendChild(resizer);
        resizer.addEventListener('mousedown', initResize);
        resizer.addEventListener('click', e => e.stopPropagation());

        let startX;
        let startWidth;

        function initResize(e) {
            e.stopPropagation();
            startX = e.pageX;
            startWidth = th.offsetWidth;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', stopResize);
        }

        function onMouseMove(e) {
            const newWidth = startWidth + (e.pageX - startX);
            th.style.width = newWidth + 'px';
        }

        function stopResize() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', stopResize);
        }
    });
}


async function loadNotifications() {
    const fd = new FormData();
    fd.append('username', username);
    const res = await fetch('/notifications', { method: 'POST', body: fd });
    const json = await res.json();
    notifications = json.notifications;
    const unread = notifications.filter(n => !n.read);
    const countElem = document.getElementById('notif-count');
    const bell = document.getElementById('notif-bell');
    if (unread.length > 0) {
        countElem.textContent = unread.length;
        countElem.classList.remove('d-none');
        bell.classList.remove('bi-bell');
        bell.classList.add('bi-bell-fill');
    } else {
        countElem.classList.add('d-none');
        bell.classList.add('bi-bell');
        bell.classList.remove('bi-bell-fill');
    }
}

async function deleteNotifications(ids) {
    const fd = new FormData();
    fd.append('username', username);
    ids.forEach(id => fd.append('ids[]', id));
    await fetch('/notifications/delete', { method: 'POST', body: fd });
}

document.getElementById('notif-list').addEventListener('click', e => e.stopPropagation());
document.getElementById('notif-clear').addEventListener('click', async (e) => {
    e.stopPropagation();
    const fd = new FormData();
    fd.append('username', username);
    await fetch('/notifications/clear', { method: 'POST', body: fd });
    notifications = [];
    document.querySelector('#notif-list tbody').innerHTML = '<tr><td colspan="3" class="text-center">Yeni bildirim yok</td></tr>';
    const countElem = document.getElementById('notif-count');
    const bell = document.getElementById('notif-bell');
    countElem.classList.add('d-none');
    bell.classList.add('bi-bell');
    bell.classList.remove('bi-bell-fill');
});
document.getElementById('notif-container').addEventListener('click', async () => {
    const list = document.getElementById('notif-list');
    const overlay = document.getElementById('notif-overlay');
    const opening = list.classList.contains('d-none');
    if (opening) {
        await loadNotifications();
        overlay.classList.remove('d-none');
    } else {
        overlay.classList.add('d-none');
    }
    list.classList.toggle('d-none');
    const tbody = list.querySelector('tbody');
    tbody.innerHTML = '';
    notifications.forEach(n => {
        const tr = document.createElement('tr');
        const dateTd = document.createElement('td');
        dateTd.textContent = n.created_at;
        tr.appendChild(dateTd);
        const msgTd = document.createElement('td');
        msgTd.textContent = n.message;
        tr.appendChild(msgTd);
        const actionTd = document.createElement('td');
        actionTd.classList.add('text-nowrap');
        if (n.team_id && !n.read) {
            const accept = document.createElement('button');
            accept.className = 'btn btn-sm btn-success me-1 d-inline-flex align-items-center justify-content-center';
            accept.style.width = '2rem';
            accept.style.height = '2rem';
            accept.innerHTML = '<i class="bi bi-check"></i>';
            accept.addEventListener('click', async () => {
                const fd = new FormData();
                fd.append('username', username);
                fd.append('team_id', n.team_id);
                await fetch('/teams/accept', { method: 'POST', body: fd });
                await deleteNotifications([n.id]);
                tr.remove();
                if (tbody.children.length === 0) {
                    const emptyRow = document.createElement('tr');
                    const emptyTd = document.createElement('td');
                    emptyTd.colSpan = 3;
                    emptyTd.className = 'text-center';
                    emptyTd.textContent = 'Yeni bildirim yok';
                    emptyRow.appendChild(emptyTd);
                    tbody.appendChild(emptyRow);
                }
                loadTeams();
                viewTeam(n.team_id);
                loadNotifications();
            });
            const reject = document.createElement('button');
            reject.className = 'btn btn-sm btn-danger d-inline-flex align-items-center justify-content-center';
            reject.style.width = '2rem';
            reject.style.height = '2rem';
            reject.innerHTML = '<i class="bi bi-x"></i>';
            reject.addEventListener('click', async () => {
                const fd = new FormData();
                fd.append('username', username);
                fd.append('team_id', n.team_id);
                await fetch('/teams/reject', { method: 'POST', body: fd });
                await deleteNotifications([n.id]);
                tr.remove();
                if (tbody.children.length === 0) {
                    const emptyRow = document.createElement('tr');
                    const emptyTd = document.createElement('td');
                    emptyTd.colSpan = 3;
                    emptyTd.className = 'text-center';
                    emptyTd.textContent = 'Yeni bildirim yok';
                    emptyRow.appendChild(emptyTd);
                    tbody.appendChild(emptyRow);
                }
                loadNotifications();
            });
            actionTd.appendChild(accept);
            actionTd.appendChild(reject);
        }
        tr.appendChild(actionTd);
        tbody.appendChild(tr);
    });
    if (notifications.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.className = 'text-center';
        td.textContent = 'Yeni bildirim yok';
        tr.appendChild(td);
        tbody.appendChild(tr);
    }
    if (opening) {
        const unreadIds = notifications.filter(n => !n.read && !n.team_id).map(n => n.id);
        if (unreadIds.length > 0) {
            await deleteNotifications(unreadIds);
            await loadNotifications();
        }
    }
});

loadNotifications();
setInterval(loadNotifications, 30000);

function showSection(id) {
    Object.values(sections).forEach(sec => sec.classList.add('d-none'));
    const section = sections[id];
    if (section) {
        section.classList.remove('d-none');
        if (id !== 'team-details') {
            window.location.hash = id;
            localStorage.setItem(SECTION_KEY, id);
        }
        if (id === 'files') {
            loadFiles();
        } else if (id === 'incoming') {
            loadIncoming();
        } else if (id === 'outgoing') {
            loadOutgoing();
        } else if (id === 'pending') {
            loadPending();
        } else if (id === 'activities') {
            loadActivities();
        }
    }
}

document.addEventListener('click', (e) => {
    const list = document.getElementById('notif-list');
    const overlay = document.getElementById('notif-overlay');
    if (!list.classList.contains('d-none') && !e.target.closest('#notif-container')) {
        list.classList.add('d-none');
        overlay.classList.add('d-none');
    }
    if (e.target.matches('#sidebar .nav-link')) {
        e.preventDefault();
        const teamId = e.target.dataset.teamId;
        if (teamId) {
            viewTeam(teamId);
        } else {
            const target = e.target.getAttribute('href').substring(1);
            showSection(target);
        }
    }
});

function updateActionButtons() {
    const disabled = selected.size === 0;
    deleteBtn.disabled = disabled;
    if (adminMode) {
        shareBtn.disabled = true;
        addToTeamBtn.disabled = true;
        publicShareBtn.disabled = true;
        publicShareBtn.textContent = 'Paylaş';
        return;
    }
    shareBtn.disabled = disabled;
    addToTeamBtn.disabled = disabled;
    publicShareBtn.disabled = disabled || selected.size !== 1;
    let label = 'Paylaş';
    publicShareBtn.classList.add('btn-outline-primary');
    publicShareBtn.classList.remove('btn-primary');
    if (selected.size === 1) {
        const filename = Array.from(selected)[0];
        const file = currentFiles.find(f => f.title === filename);
        if (file && file.link) {
            publicShareBtn.classList.add('btn-primary');
            publicShareBtn.classList.remove('btn-outline-primary');
            label = 'Paylaşımı Durdur';
        }
    }
    publicShareBtn.textContent = label;
}

function renderPagination(totalPages) {
    pagination.innerHTML = '';
    const prevLi = document.createElement('li');
    prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
    const prevLink = document.createElement('a');
    prevLink.className = 'page-link';
    prevLink.href = '#';
    prevLink.textContent = 'Önceki';
    prevLink.addEventListener('click', e => {
        e.preventDefault();
        if (currentPage > 1) {
            setCurrentPage(currentPage - 1);
            renderFiles();
        }
    });
    prevLi.appendChild(prevLink);
    pagination.appendChild(prevLi);

    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (currentPage === i ? ' active' : '');
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = i;
        a.addEventListener('click', e => {
            e.preventDefault();
            setCurrentPage(i);
            renderFiles();
        });
        li.appendChild(a);
        pagination.appendChild(li);
    }

    const nextLi = document.createElement('li');
    nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
    const nextLink = document.createElement('a');
    nextLink.className = 'page-link';
    nextLink.href = '#';
    nextLink.textContent = 'Sonraki';
    nextLink.addEventListener('click', e => {
        e.preventDefault();
        if (currentPage < totalPages) {
            setCurrentPage(currentPage + 1);
            renderFiles();
        }
    });
    nextLi.appendChild(nextLink);
    pagination.appendChild(nextLi);
}

function renderFiles() {
    const term = searchInput.value.toLowerCase();
    let files = currentFiles.filter(f => {
        const values = [
            f.title,
            f.added,
            f.expires_at,
            f.public_expires_at,
            f.extension,
            f.description,
            f.size,
            f.username
        ].map(v => (v || '').toString().toLowerCase());
        return values.some(v => v.includes(term));
    });
    if (currentSort.field) {
        files.sort((a, b) => {
            let av, bv;
            if (currentSort.field === 'expires_at') {
                av = a.public_expires_at || a.expires_at || '';
                bv = b.public_expires_at || b.expires_at || '';
            } else if (currentSort.field === 'title') {
                av = adminMode ? `${a.username} - ${a.title}` : a.title;
                bv = adminMode ? `${b.username} - ${b.title}` : b.title;
            } else {
                av = a[currentSort.field] || '';
                bv = b[currentSort.field] || '';
            }
            if (currentSort.field === 'size') {
                av = Number(av);
                bv = Number(bv);
            } else {
                av = av.toString().toLowerCase();
                bv = bv.toString().toLowerCase();
            }
            if (av < bv) return -1 * currentSort.dir;
            if (av > bv) return 1 * currentSort.dir;
            return 0;
        });
    }
    const size = parseInt(pageSizeSelect.value);
    const totalPages = Math.max(1, Math.ceil(files.length / size));
    if (currentPage > totalPages) setCurrentPage(totalPages);
    const start = (currentPage - 1) * size;
    const pageFiles = files.slice(start, start + size);
    const tbody = document.querySelector('#file-table tbody');
    tbody.innerHTML = '';
    pageFiles.forEach(file => {
        const tr = document.createElement('tr');

        const cbTd = document.createElement('td');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = adminMode ? `${file.username}|${file.title}` : file.title;
        cb.checked = selected.has(cb.value);
        cb.addEventListener('change', () => {
            if (cb.checked) {
                selected.add(cb.value);
            } else {
                selected.delete(cb.value);
            }
            updateSelectedStorage();
            updateActionButtons();
        });
        cbTd.appendChild(cb);
        tr.appendChild(cbTd);

        const titleTd = document.createElement('td');
        titleTd.textContent = adminMode ? `${file.username} - ${file.title}` : file.title;
        if (file.link) {
            const linkBtn = document.createElement('button');
            linkBtn.className = 'btn btn-sm ms-2';
            const linkIcon = document.createElement('i');
            linkIcon.classList.add('bi', 'me-1');
            linkBtn.appendChild(linkIcon);
            linkBtn.append('Link');

            if (file.rejected) {
                linkBtn.classList.add('btn-danger');
                linkBtn.title = 'Reddedildi';
                linkBtn.disabled = true;
                linkIcon.classList.add('bi-x');
            } else if (file.approved) {
                linkBtn.classList.add('btn-success');
                linkBtn.title = 'Onaylandı';
                linkIcon.classList.add('bi-check');
            } else {
                linkBtn.classList.add('btn-warning');
                linkBtn.title = 'Onay bekliyor';
                linkIcon.classList.add('bi-hourglass-split');
            }
            linkBtn.addEventListener('click', async () => {
                const url = window.location.origin + file.link;
                try {
                    await navigator.clipboard.writeText(url);
                } catch (e) {
                    const tmp = document.createElement('textarea');
                    tmp.value = url;
                    document.body.appendChild(tmp);
                    tmp.select();
                    document.execCommand('copy');
                    tmp.remove();
                }
                const msg = document.createElement('span');
                msg.className = 'ms-2 text-success';
                msg.textContent = 'URL kopyalandı';
                linkBtn.insertAdjacentElement('afterend', msg);
                setTimeout(() => msg.remove(), 2000);
            });
            titleTd.appendChild(linkBtn);
            const dlBtn = document.createElement('button');
            dlBtn.className = 'btn btn-sm btn-outline-secondary ms-2';
            dlBtn.textContent = `${file.download_count} İndirme`;
            dlBtn.addEventListener('click', () => showDownloadLogs(file));
            titleTd.appendChild(dlBtn);
        }
        tr.appendChild(titleTd);

        const addedTd = document.createElement('td');
        addedTd.textContent = file.added;
        tr.appendChild(addedTd);

        const expTd = document.createElement('td');
        expTd.textContent = file.public_expires_at || file.expires_at;
        tr.appendChild(expTd);

        const extTd = document.createElement('td');
        extTd.textContent = file.extension;
        tr.appendChild(extTd);

        const descTd = document.createElement('td');
        descTd.textContent = file.description;
        tr.appendChild(descTd);

        const sizeTd = document.createElement('td');
        sizeTd.textContent = formatSize(file.size);
        tr.appendChild(sizeTd);

        tbody.appendChild(tr);
    });

    renderPagination(totalPages);
    updateActionButtons();
}

async function loadFiles() {
    loadSelected(); // Restore persisted selections so auto-refresh preserves checkbox state
    const formData = new FormData();
    formData.append('username', username);
    if (adminMode) {
        formData.append('admin', '1');
    }
    const res = await fetch('/list', { method: 'POST', body: formData });
    const json = await res.json();
    currentFiles = json.files;
    const existing = new Set(
        json.files.map(f => (adminMode ? `${f.username}|${f.title}` : f.title))
    );
    for (const value of Array.from(selected)) {
        if (!existing.has(value)) {
            selected.delete(value);
        }
    }
    updateSelectedStorage();
    renderFiles();
    if (json.files.some(f => f.link && !f.approved)) {
        setTimeout(loadFiles, 5000);
    }
}

async function showDownloadLogs(file) {
    const fd = new FormData();
    fd.append('username', adminMode ? file.username : username);
    fd.append('filename', file.title);
    const res = await fetch('/download/logs', { method: 'POST', body: fd });
    const json = await res.json();
    const tbody = document.getElementById('download-log-body');
    tbody.innerHTML = '';
    json.logs.forEach(log => {
        const tr = document.createElement('tr');
        const tsTd = document.createElement('td');
        tsTd.textContent = log.timestamp;
        tr.appendChild(tsTd);
        const ipTd = document.createElement('td');
        ipTd.textContent = log.ip_address;
        tr.appendChild(ipTd);
        const countryTd = document.createElement('td');
        countryTd.textContent = log.country;
        tr.appendChild(countryTd);
        tbody.appendChild(tr);
    });
    if (json.logs.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.className = 'text-center';
        td.textContent = 'Kayıt yok';
        tr.appendChild(td);
        tbody.appendChild(tr);
    }
    const modal = new bootstrap.Modal(document.getElementById('downloadLogModal'));
    modal.show();
}

async function loadIncoming() {
    const fd = new FormData();
    fd.append('username', username);
    const res = await fetch('/incoming', { method: 'POST', body: fd });
    const json = await res.json();
    const tbody = document.querySelector('#incoming-table tbody');
    tbody.innerHTML = '';
    json.files.forEach(file => {
        const tr = document.createElement('tr');
        const nameTd = document.createElement('td');
        nameTd.textContent = file.filename;
        tr.appendChild(nameTd);
        const senderTd = document.createElement('td');
        senderTd.textContent = file.sender;
        tr.appendChild(senderTd);
       const expTd = document.createElement('td');
        expTd.textContent = file.expires_at;
        tr.appendChild(expTd);
        tbody.appendChild(tr);
    });
}

async function loadOutgoing() {
    const fd = new FormData();
    fd.append('username', username);
    const res = await fetch('/outgoing', { method: 'POST', body: fd });
    const json = await res.json();
    const tbody = document.querySelector('#outgoing-table tbody');
    tbody.innerHTML = '';
    json.files.forEach(file => {
        const tr = document.createElement('tr');
        const nameTd = document.createElement('td');
        nameTd.textContent = file.filename;
        tr.appendChild(nameTd);
        const targetTd = document.createElement('td');
        targetTd.textContent = file.target;
        tr.appendChild(targetTd);
        const expTd = document.createElement('td');
        expTd.textContent = file.expires_at;
        tr.appendChild(expTd);
        const actTd = document.createElement('td');
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-danger';
        btn.textContent = 'Sil';
        btn.addEventListener('click', async () => {
            const data = new FormData();
            data.append('username', username);
            data.append('filename', file.filename);
            data.append('target', file.target_id);
            data.append('type', file.type);
            await fetch('/outgoing/delete', { method: 'POST', body: data });
            loadOutgoing();
        });
        actTd.appendChild(btn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
    });
}

async function loadPending() {
    const fd = new FormData();
    fd.append('username', username);
    if (adminMode) {
        fd.append('admin', '1');
    }
    const res = await fetch('/share/pending', { method: 'POST', body: fd });
    const json = await res.json();
    const tbody = document.querySelector('#pending-table tbody');
    tbody.innerHTML = '';
    json.shares.forEach(item => {
        const tr = document.createElement('tr');
        const fileTd = document.createElement('td');
        const nameSpan = document.createElement('span');
        nameSpan.textContent = item.filename;
        fileTd.appendChild(nameSpan);

        const ext = item.filename.split('.').pop().toLowerCase();
        const previewable = ['pdf', 'png', 'jpg', 'jpeg', 'xlsx', 'docx', 'pptx', 'csv'];
        const archiveExts = ['zip', 'rar', 'tar', 'gz', 'tgz', 'tar.gz'];
        const imageExts = ['png', 'jpg', 'jpeg'];
        if (previewable.includes(ext) || archiveExts.includes(ext)) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-outline-secondary ms-2';
            btn.innerHTML = '<i class="bi bi-eye"></i>';
            btn.addEventListener('click', async () => {
                const modalContent = document.getElementById('preview-content');
                modalContent.innerHTML = '';
                if (archiveExts.includes(ext)) {
                    const res = await fetch(`/preview/${item.token}?list=1`);
                    const data = await res.json();
                    modalContent.innerHTML = `<ul class="mb-0">${data.files.map(f => `<li>${f}</li>`).join('')}</ul>`;
                } else if (imageExts.includes(ext)) {
                    modalContent.innerHTML = `<img src="/preview/${item.token}" class="img-fluid" />`;
                } else if (ext === 'csv') {
                    const res = await fetch(`/preview/${item.token}`);
                    const text = await res.text();
                    const pre = document.createElement('pre');
                    pre.className = 'mb-0';
                    pre.textContent = text;
                    modalContent.appendChild(pre);
                } else {
                    modalContent.innerHTML = `<iframe src="/preview/${item.token}" style="width:100%;height:600px;"></iframe>`;
                }
                const modal = new bootstrap.Modal(document.getElementById('previewModal'));
                modal.show();
            });
            fileTd.appendChild(btn);
        }

        const dl = document.createElement('a');
        dl.href = `/preview/${item.token}?download=1`;
        dl.className = 'btn btn-sm btn-outline-primary ms-2';
        dl.innerHTML = '<i class="bi bi-download"></i>';
        fileTd.appendChild(dl);

        tr.appendChild(fileTd);
        const userTd = document.createElement('td');
        userTd.textContent = item.username;
        tr.appendChild(userTd);
        const expTd = document.createElement('td');
        expTd.textContent = item.expires_at;
        tr.appendChild(expTd);
        const actTd = document.createElement('td');
        const approveBtn = document.createElement('button');
        approveBtn.className = 'btn btn-sm btn-success me-2';
        approveBtn.textContent = 'Onayla';
        approveBtn.addEventListener('click', async () => {
            await fetch(`/share/approve/${item.token}`);
            loadPending();
        });
        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn btn-sm btn-danger';
        rejectBtn.textContent = 'Reddet';
        rejectBtn.addEventListener('click', async () => {
            await fetch(`/share/reject/${item.token}`);
            loadPending();
        });
        actTd.appendChild(approveBtn);
        actTd.appendChild(rejectBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
    });
    const pendingMenu = document.getElementById('pending-menu-item');
    if (json.shares.length === 0) {
        pendingMenu.classList.add('d-none');
    } else {
        pendingMenu.classList.remove('d-none');
    }
}

async function loadActivities() {
    const fd = new FormData();
    fd.append('username', username);
    const res = await fetch('/activities', { method: 'POST', body: fd });
    const json = await res.json();
    activities = json.activities;
    const tbody = document.querySelector('#activities-table tbody');
    tbody.innerHTML = '';
    json.activities.forEach(act => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${act.username}</td><td>${act.message}</td><td>${act.category}</td><td>${act.created_at}</td>`;
        tbody.appendChild(tr);
    });
}

deleteBtn.addEventListener('click', async () => {
    for (const value of selected) {
        const formData = new FormData();
        if (adminMode) {
            const [user, filename] = value.split('|');
            formData.append('username', user);
            formData.append('filename', filename);
        } else {
            formData.append('username', username);
            formData.append('filename', value);
        }
        await fetch('/delete', { method: 'POST', body: formData });
    }
    await loadFiles();
});

publicShareBtn.addEventListener('click', () => {
    const filename = Array.from(selected)[0];
    const file = currentFiles.find(f => f.title === filename);
    if (file && file.link) {
        const formData = new FormData();
        formData.append('username', username);
        formData.append('filename', filename);
        fetch('/share/delete', { method: 'POST', body: formData }).then(() => loadFiles());
    } else {
        shareFileName = filename;
        const modal = new bootstrap.Modal(document.getElementById('shareLinkModal'));
        modal.show();
    }
});

document.getElementById('share-confirm').addEventListener('click', async () => {
    const days = document.getElementById('share-expiry').value;
    const formData = new FormData();
    formData.append('username', username);
    formData.append('filename', shareFileName);
    formData.append('days', days);
    await fetch('/share', { method: 'POST', body: formData });
    bootstrap.Modal.getInstance(document.getElementById('shareLinkModal')).hide();
    await loadFiles();
});

addToTeamBtn.addEventListener('click', () => {
    teamModalMode = 'add-files';
    const select = document.getElementById('team-select');
    select.innerHTML = '';
    teams.forEach(team => {
        const opt = document.createElement('option');
        opt.value = team.id;
        opt.textContent = team.name;
        select.appendChild(opt);
    });
    const modal = new bootstrap.Modal(document.getElementById('teamModal'));
    modal.show();
});

shareBtn.addEventListener('click', async () => {
    shareFileName = null;
    shareFileNames = Array.from(selected);
    shareExpiry = '';
    userModalMode = 'share-user';
    const res = await fetch('/users/tree');
    const json = await res.json();
    const container = document.getElementById('ou-tree');
    container.innerHTML = '';
    renderTree(json.tree, container, username);
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
});

document.getElementById('team-modal-add').addEventListener('click', async () => {
    const teamId = document.getElementById('team-select').value;
    const data = new FormData();
    data.append('username', username);
    data.append('team_id', teamId);
    if (teamModalMode === 'add-files') {
        for (const f of selected) {
            data.append('filenames', f);
        }
    } else if (teamModalMode === 'share-team') {
        data.append('filenames', shareFileName);
        if (shareExpiry) {
            data.append('expires_at', shareExpiry);
        }
    }
    await fetch('/teams/add_files', { method: 'POST', body: data });
    bootstrap.Modal.getInstance(document.getElementById('teamModal')).hide();
    teamModalMode = 'add-files';
    shareFileName = null;
    shareExpiry = '';
});

async function shareWithUser(filename, recipient, expiresAt) {
    const fd = new FormData();
    fd.append('username', username);
    fd.append('filename', filename);
    fd.append('recipient', recipient);
    if (expiresAt) {
        fd.append('expires_at', expiresAt);
    }
    await fetch('/share/user', { method: 'POST', body: fd });
}

function formatSize(bytes) {
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let unit = 0;
    while (size >= 1024 && unit < units.length - 1) {
        size /= 1024;
        unit++;
    }
    return size.toFixed(1) + ' ' + units[unit];
}

async function viewTeam(teamId) {
    const data = new FormData();
    data.append('username', username);
    data.append('team_id', teamId);
    const res = await fetch('/teams/details', { method: 'POST', body: data });
    const json = await res.json();
    if (!json.success) {
        return;
    }
    const team = json.team;
    currentTeamId = team.id;
    window.location.hash = `team-${team.id}`;
    document.getElementById('team-title').textContent = team.name;
    const membersList = document.getElementById('team-members-list');
    membersList.innerHTML = '';
    team.members.forEach(m => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const span = document.createElement('span');
        span.textContent = m.name;
        if (!m.accepted) {
            span.textContent += ' (Kabul Bekleniyor)';
        }
        li.appendChild(span);
        if (m.username === team.creator) {
            const badge = document.createElement('button');
            badge.type = 'button';
            badge.className = 'btn btn-sm btn-warning';
            badge.textContent = 'Kurucu';
            badge.disabled = true;
            li.appendChild(badge);
        } else if (m.username === username && !m.accepted) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-success';
            btn.textContent = 'Kabul Et';
            btn.addEventListener('click', async () => {
                const fd = new FormData();
                fd.append('username', username);
                fd.append('team_id', team.id);
                await fetch('/teams/accept', { method: 'POST', body: fd });
                loadTeams();
                viewTeam(team.id);
            });
            li.appendChild(btn);
        } else if (username === team.creator || m.username === username) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm ' + (m.username === username ? 'btn-outline-secondary' : 'btn-danger');
            btn.textContent = m.username === username ? 'Ayrıl' : 'Sil';
            btn.addEventListener('click', async () => {
                const fd = new FormData();
                fd.append('username', username);
                fd.append('team_id', team.id);
                fd.append('member', m.username);
                await fetch('/teams/remove_member', { method: 'POST', body: fd });
                if (m.username === username) {
                    loadTeams();
                    showSection('teams');
                } else {
                    viewTeam(team.id);
                    loadTeams();
                }
            });
            li.appendChild(btn);
        }
        membersList.appendChild(li);
    });
    const filesList = document.getElementById('team-files-list');
    filesList.innerHTML = '';
    team.files.forEach(f => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<span>${f.filename} (${f.username})</span>`;
        if (adminMode || f.username === username || team.creator === username) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-danger';
            btn.innerHTML = '<i class="bi bi-trash"></i>';
            btn.addEventListener('click', async () => {
                const fd = new FormData();
                fd.append('username', username);
                fd.append('team_id', team.id);
                fd.append('filename', f.filename);
                await fetch('/teams/delete_file', { method: 'POST', body: fd });
                viewTeam(team.id);
            });
            li.appendChild(btn);
        }
        filesList.appendChild(li);
    });
    const container = document.getElementById('add-member-container');
    container.classList.toggle('d-none', team.creator !== username);
    showSection('team-details');
}

async function loadTeams() {
    const formData = new FormData();
    formData.append('username', username);
    if (adminMode) {
        formData.append('admin', '1');
    }
    const res = await fetch('/teams/list', { method: 'POST', body: formData });
    const json = await res.json();
    const list = document.getElementById('team-list');
    list.innerHTML = '';
    teams = json.teams;
    const menu = document.getElementById('team-menu');
    menu.innerHTML = '';
    teams.forEach(team => {
        const menuItem = document.createElement('li');
        menuItem.className = 'nav-item';
        const link = document.createElement('a');
        link.className = 'nav-link';
        link.href = '#team-details';
        link.dataset.teamId = team.id;
        link.innerHTML = '<i class="bi bi-people me-2"></i>' + team.name;
        menuItem.appendChild(link);
        menu.appendChild(menuItem);

        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.style.cursor = 'pointer';
        li.addEventListener('click', () => viewTeam(team.id));

        const nameSpan = document.createElement('span');
        nameSpan.textContent = team.name;
        li.appendChild(nameSpan);

        const membersSpan = document.createElement('span');
        membersSpan.className = 'ms-2';
        membersSpan.textContent = `(${team.members.map(m => m.name).join(', ')})`;
        li.appendChild(membersSpan);

        const btn = document.createElement('button');
        const isCreator = adminMode || team.creator === username;
        btn.className = 'btn btn-sm ' + (isCreator ? 'btn-danger' : 'btn-outline-secondary');
        btn.textContent = isCreator ? 'Sil' : 'Ayrıl';
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const data = new FormData();
            data.append('username', username);
            data.append('team_id', team.id);
            await fetch(isCreator ? '/teams/delete' : '/teams/leave', { method: 'POST', body: data });
            loadTeams();
        });
        li.appendChild(btn);

        list.appendChild(li);
    });
}

document.getElementById('team-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('username', username);
    formData.append('team_name', document.getElementById('team-name').value);
    const members = Array.from(document.getElementById('team-members').selectedOptions).map(o => o.value).join(',');
    formData.append('members', members);
    const res = await fetch('/teams/create', { method: 'POST', body: formData });
    const json = await res.json();
    if (json.success) {
        document.getElementById('team-form').reset();
        loadTeams();
    }
});

loadTeams();
loadPending();
const initialHash = window.location.hash ? window.location.hash.substring(1) : (localStorage.getItem(SECTION_KEY) || '');
if (initialHash.startsWith('team-')) {
    const teamId = initialHash.substring(5);
    viewTeam(teamId);
} else {
    const initialSection = initialHash || 'upload';
    showSection(initialSection);
}

document.getElementById('load-users').addEventListener('click', async () => {
    userModalMode = 'create';
    const res = await fetch('/users/tree');
    const json = await res.json();
    const container = document.getElementById('ou-tree');
    container.innerHTML = '';
    renderTree(json.tree, container, username);
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
});

document.getElementById('add-member-btn').addEventListener('click', async () => {
    userModalMode = 'add-member';
    const res = await fetch('/users/tree');
    const json = await res.json();
    const container = document.getElementById('ou-tree');
    container.innerHTML = '';
    renderTree(json.tree, container, username);
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
});

document.getElementById('user-modal-add').addEventListener('click', async () => {
    const checkboxes = document.querySelectorAll('#ou-tree input.user-checkbox:checked');
    if (userModalMode === 'create') {
        const select = document.getElementById('team-members');
        checkboxes.forEach(cb => {
            if (!Array.from(select.options).some(o => o.value === cb.value)) {
                const opt = document.createElement('option');
                opt.value = cb.value;
                opt.textContent = cb.dataset.name;
                opt.selected = true;
                select.appendChild(opt);
            }
            cb.checked = false;
        });
    } else if (userModalMode === 'add-member') {
        for (const cb of checkboxes) {
            const data = new FormData();
            data.append('username', username);
            data.append('team_id', currentTeamId);
            data.append('new_member', cb.value);
            await fetch('/teams/add_member', { method: 'POST', body: data });
            cb.checked = false;
        }
        viewTeam(currentTeamId);
        loadTeams();
    } else if (userModalMode === 'share-user') {
        for (const cb of checkboxes) {
            if (shareFileName) {
                await shareWithUser(shareFileName, cb.value, shareExpiry);
            } else {
                for (const f of shareFileNames) {
                    await shareWithUser(f, cb.value, shareExpiry);
                }
            }
            cb.checked = false;
        }
    }
    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
    userModalMode = 'create';
    shareFileName = null;
    shareFileNames = [];
    shareExpiry = '';
});

function nodeContainsUser(node, username) {
    if (node.users && node.users.some(u => u.username === username)) {
        return true;
    }
    if (node.children) {
        return node.children.some(child => nodeContainsUser(child, username));
    }
    return false;
}

function renderTree(nodes, parent, username) {
    const ul = document.createElement('ul');
    nodes.forEach(node => {
        if (/pc/i.test(node.name)) {
            return;
        }
        const li = document.createElement('li');
        const details = document.createElement('details');
        const summary = document.createElement('summary');
        summary.textContent = node.name;
        details.appendChild(summary);
        if (node.users && node.users.length > 0) {
            const userUl = document.createElement('ul');
            node.users.forEach(u => {
                const userLi = document.createElement('li');
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.className = 'user-checkbox';
                cb.value = u.username;
                cb.dataset.name = `${u.givenName} ${u.sn}`.trim();
                const label = document.createElement('span');
                label.textContent = `${u.givenName} ${u.sn}`.trim();
                userLi.appendChild(cb);
                userLi.appendChild(label);
                userUl.appendChild(userLi);
            });
            details.appendChild(userUl);
        }
        if (node.children && node.children.length > 0) {
            renderTree(node.children, details, username);
        }
        if (nodeContainsUser(node, username)) {
            details.open = true;
        }
        li.appendChild(details);
        ul.appendChild(li);
    });
    parent.appendChild(ul);
}

const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('bg-light');
});
dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('bg-light');
});
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('bg-light');
    addFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', () => addFiles(fileInput.files));
const uploadBtn = document.getElementById('upload-btn');
uploadBtn.addEventListener('click', handleUpload);

const fileList = document.getElementById('file-list');
const pendingTitle = document.getElementById('pending-title');
let pendingFiles = [];
function addFiles(files) {
    if (pendingFiles.length === 0) {
        pendingTitle.classList.remove('d-none');
    }
    for (const file of files) {
        const item = { file, description: '' };
        pendingFiles.push(item);
        const li = document.createElement('li');
        li.className = 'list-group-item';
        const header = document.createElement('div');
        header.className = 'd-flex justify-content-between align-items-center';
        header.textContent = `${file.name} - ${formatSize(file.size)}`;
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-link text-danger p-0';
        removeBtn.innerHTML = '<i class="bi bi-x-circle"></i>';
        removeBtn.addEventListener('click', () => {
            pendingFiles = pendingFiles.filter(p => p !== item);
            li.remove();
            if (pendingFiles.length === 0) {
                pendingTitle.classList.add('d-none');
                uploadBtn.classList.add('d-none');
            }
        });
        header.appendChild(removeBtn);
        li.appendChild(header);
        const descInput = document.createElement('input');
        descInput.type = 'text';
        descInput.className = 'form-control mt-2';
        descInput.placeholder = 'Açıklama';
        descInput.addEventListener('input', e => item.description = e.target.value);
        li.appendChild(descInput);
        fileList.appendChild(li);
    }
    uploadBtn.classList.remove('d-none');
}

async function handleUpload() {
    const result = document.getElementById('upload-result');
    result.innerHTML = '';
    const days = document.getElementById('file-expiry').value;
    const expiry = days === '0' ? '' : (() => {
        const d = new Date();
        d.setDate(d.getDate() + parseInt(days));
        return d.toISOString().split('T')[0];
    })();
    if (pendingFiles.length === 0) {
        result.innerHTML = '<div class="alert alert-danger">Dosya gerekli</div>';
        return;
    }
    const uploaded = [];
    for (const item of pendingFiles) {
        try {
            const savedName = await uploadFile(item.file, expiry, item.description);
            uploaded.push(savedName);
        } catch (e) {
            result.innerHTML = '<div class="alert alert-danger">' + (e.message || 'Hata') + '</div>';
            return;
        }
    }
    result.innerHTML += '<div class="alert alert-success">Dosyalar yüklendi</div>';
    loadFiles();
    pendingFiles = [];
    fileList.innerHTML = '';
    pendingTitle.classList.add('d-none');
    uploadBtn.classList.add('d-none');
}

async function uploadFile(file, expiry, description) {
    const chunkSize = 5 * 1024 * 1024; // 5MB
    const totalChunks = Math.ceil(file.size / chunkSize);
    const bar = createProgressBar(file.name);
    let finalName = file.name;

    for (let i = 0; i < totalChunks; i++) {
        const start = i * chunkSize;
        const end = Math.min(file.size, start + chunkSize);
        const chunk = file.slice(start, end);
        const formData = new FormData();
        formData.append('username', username);
        formData.append('filename', file.name);
        formData.append('chunk_index', i);
        formData.append('total_chunks', totalChunks);
        formData.append('expires_at', expiry);
        formData.append('file', chunk);
        formData.append('description', description);
        const res = await fetch('/upload', { method: 'POST', body: formData });
        const contentType = res.headers.get('Content-Type') || '';
        if (!contentType.includes('application/json')) {
            const text = await res.text();
            throw new Error(text || 'Yükleme başarısız');
        }
        const json = await res.json();
        if (!res.ok || !json.success) {
            throw new Error(json.error || 'Yükleme başarısız');
        }
        if (json.filenames && json.filenames.length > 0) {
            finalName = json.filenames[0];
        }
        const percent = Math.round((i + 1) / totalChunks * 100);
        bar.style.width = percent + '%';
        bar.textContent = percent + '%';
    }
    bar.classList.add('bg-success');
    bar.textContent = '100%';
    return finalName;
}

function createProgressBar(filename) {
    const container = document.createElement('div');
    container.className = 'mb-2';
    const label = document.createElement('div');
    label.textContent = filename;
    const progress = document.createElement('div');
    progress.className = 'progress';
    const bar = document.createElement('div');
    bar.className = 'progress-bar';
    bar.style.width = '0%';
    bar.textContent = '0%';
    progress.appendChild(bar);
    container.appendChild(label);
    container.appendChild(progress);
    document.getElementById('upload-result').appendChild(container);
    return bar;
}
</script>
</body>
</html>

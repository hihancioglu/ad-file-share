<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Share</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="d-flex">
    <nav id="sidebar" class="collapse collapse-horizontal show bg-light border-end" style="--bs-collapse-width: 250px;">
        <div class="p-3">
            <h5>Menü</h5>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="#upload">Yükle</a></li>
                <li class="nav-item"><a class="nav-link" href="#files">Dosyalarım</a></li>
                <li class="nav-item"><a class="nav-link" href="#teams">Ekipler</a></li>
            </ul>
        </div>
    </nav>

    <div class="flex-grow-1 p-3">
        <button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar">
            &#9776;
        </button>
        <h1>Hoş geldin, <span id="username-display"></span></h1>

        <section id="upload" class="mb-4">
            <h2>Dosya Yükle</h2>
            <div id="drop-zone" class="mb-3 border border-primary rounded p-5 text-center" style="cursor: pointer;">
                Dosyaları buraya sürükleyin veya tıklayın
                <input type="file" id="file-input" name="files" multiple hidden>
            </div>
            <div id="upload-result" class="mt-2"></div>
        </section>

        <section id="files">
            <h2>Dosyalarım</h2>
            <button id="delete-selected" class="btn btn-danger mb-2" disabled>Sil</button>
            <table id="file-table" class="table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Başlık</th>
                        <th>Eklenme Tarihi</th>
                        <th>Uzantı</th>
                        <th>Açıklama</th>
                        <th>Boyut</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="teams" class="mt-4">
            <h2>Ekipler</h2>
            <form id="team-form" class="mb-3">
                <input type="text" id="team-name" class="form-control mb-2" placeholder="Ekip adı" required>
                <input type="text" id="team-members" class="form-control mb-2" placeholder="Üyeler (virgülle ayır)">
                <button class="btn btn-primary" type="submit">Oluştur</button>
            </form>
            <ul id="team-list" class="list-group"></ul>
        </section>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const username = localStorage.getItem('username');
if (!username) {
    window.location.href = '/';
}

document.getElementById('username-display').textContent = username;

const selected = new Set();
const deleteBtn = document.getElementById('delete-selected');

async function loadFiles() {
    const formData = new FormData();
    formData.append('username', username);
    const res = await fetch('/list', { method: 'POST', body: formData });
    const json = await res.json();
    const tbody = document.querySelector('#file-table tbody');
    tbody.innerHTML = '';
    selected.clear();
    deleteBtn.disabled = true;
    json.files.forEach(file => {
        const tr = document.createElement('tr');

        const cbTd = document.createElement('td');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = file.title;
        cb.addEventListener('change', () => {
            if (cb.checked) {
                selected.add(cb.value);
            } else {
                selected.delete(cb.value);
            }
            deleteBtn.disabled = selected.size === 0;
        });
        cbTd.appendChild(cb);
        tr.appendChild(cbTd);

        const titleTd = document.createElement('td');
        titleTd.textContent = file.title;
        tr.appendChild(titleTd);

        const addedTd = document.createElement('td');
        addedTd.textContent = file.added;
        tr.appendChild(addedTd);

        const extTd = document.createElement('td');
        extTd.textContent = file.extension;
        tr.appendChild(extTd);

        const descTd = document.createElement('td');
        descTd.textContent = file.description;
        tr.appendChild(descTd);

        const sizeTd = document.createElement('td');
        sizeTd.textContent = formatSize(file.size);
        tr.appendChild(sizeTd);

        tbody.appendChild(tr);
    });
}

deleteBtn.addEventListener('click', async () => {
    for (const filename of selected) {
        const formData = new FormData();
        formData.append('username', username);
        formData.append('filename', filename);
        await fetch('/delete', { method: 'POST', body: formData });
    }
    await loadFiles();
});

function formatSize(bytes) {
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let unit = 0;
    while (size >= 1024 && unit < units.length - 1) {
        size /= 1024;
        unit++;
    }
    return size.toFixed(1) + ' ' + units[unit];
}

loadFiles();

async function loadTeams() {
    const formData = new FormData();
    formData.append('username', username);
    const res = await fetch('/teams/list', { method: 'POST', body: formData });
    const json = await res.json();
    const list = document.getElementById('team-list');
    list.innerHTML = '';
    json.teams.forEach(team => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = `${team.name} (${team.members.join(', ')})`;
        const btn = document.createElement('button');
        const isCreator = team.creator === username;
        btn.className = 'btn btn-sm ' + (isCreator ? 'btn-danger' : 'btn-outline-secondary');
        btn.textContent = isCreator ? 'Sil' : 'Ayrıl';
        btn.addEventListener('click', async () => {
            const data = new FormData();
            data.append('username', username);
            data.append('team_id', team.id);
            await fetch(isCreator ? '/teams/delete' : '/teams/leave', { method: 'POST', body: data });
            loadTeams();
        });
        li.appendChild(btn);
        list.appendChild(li);
    });
}

document.getElementById('team-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('username', username);
    formData.append('team_name', document.getElementById('team-name').value);
    formData.append('members', document.getElementById('team-members').value);
    const res = await fetch('/teams/create', { method: 'POST', body: formData });
    const json = await res.json();
    if (json.success) {
        document.getElementById('team-form').reset();
        loadTeams();
    }
});

loadTeams();

const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('bg-light');
});
dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('bg-light');
});
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('bg-light');
    handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', () => handleFiles(fileInput.files));

async function handleFiles(files) {
    const result = document.getElementById('upload-result');
    result.innerHTML = '';
    for (const file of files) {
        try {
            await uploadFile(file);
        } catch (e) {
            result.innerHTML = '<div class="alert alert-danger">' + (e.message || 'Hata') + '</div>';
            return;
        }
    }
    result.innerHTML += '<div class="alert alert-success">Dosyalar yüklendi</div>';
    loadFiles();
}

async function uploadFile(file) {
    const chunkSize = 5 * 1024 * 1024; // 5MB
    const totalChunks = Math.ceil(file.size / chunkSize);
    const bar = createProgressBar(file.name);

    for (let i = 0; i < totalChunks; i++) {
        const start = i * chunkSize;
        const end = Math.min(file.size, start + chunkSize);
        const chunk = file.slice(start, end);
        const formData = new FormData();
        formData.append('username', username);
        formData.append('filename', file.name);
        formData.append('chunk_index', i);
        formData.append('total_chunks', totalChunks);
        formData.append('file', chunk);
        const res = await fetch('/upload', { method: 'POST', body: formData });
        const json = await res.json();
        if (!json.success) {
            throw new Error(json.error || 'Yükleme başarısız');
        }
        bar.style.width = ((i + 1) / totalChunks * 100) + '%';
    }
    bar.classList.add('bg-success');
}

function createProgressBar(filename) {
    const container = document.createElement('div');
    container.className = 'mb-2';
    const label = document.createElement('div');
    label.textContent = filename;
    const progress = document.createElement('div');
    progress.className = 'progress';
    const bar = document.createElement('div');
    bar.className = 'progress-bar';
    bar.style.width = '0%';
    progress.appendChild(bar);
    container.appendChild(label);
    container.appendChild(progress);
    document.getElementById('upload-result').appendChild(container);
    return bar;
}
</script>
</body>
</html>
